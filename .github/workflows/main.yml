name: Main

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 31.220.80.11
          username: root
          port: 22
          key: ${{ secrets.SSHKEY }}
          script: |
            set -e
            export PATH="$HOME/.local/share/pnpm:$PATH"
            cd ~/axon-digital || exit 1
            git fetch origin main
            git reset --hard origin/main

            # Deploy backend
            cd backend
            pnpm install
            pnpm run build
            echo "ğŸ“¦ Backend build completed"

            # Check if Playwright browsers are installed (only install if missing)
            # This is a one-time setup, but we check to avoid reinstalling on every deploy
            if ! find "$HOME/.cache/ms-playwright" -name "chrome" -o -name "chromium" 2>/dev/null | grep -q .; then
              echo "ğŸ“¦ Playwright browsers not found, installing (one-time setup)..."
              npx playwright install --with-deps chromium || echo "âš ï¸ Playwright install failed, continuing..."
            else
              echo "âœ… Playwright browsers already installed"
            fi

            # Check if process exists and get status
            echo "ğŸ” Checking pm2 status for pdf-service..."
            pm2 list || echo "âš ï¸ pm2 list failed"
            pm2 describe pdf-service 2>/dev/null || echo "âš ï¸ pdf-service not found in pm2"

            # Try to reload, if fails start new
            if pm2 reload pdf-service 2>/dev/null; then
              echo "âœ… pdf-service reloaded successfully"
            else
              echo "âš ï¸ pdf-service reload failed, starting new process..."
              cd ~/axon-digital/backend
              pm2 start "pnpm run start" --name pdf-service --interpreter bash --cwd ~/axon-digital/backend || {
                echo "âŒ Failed to start pdf-service"
                pm2 logs pdf-service --lines 50 --nostream || echo "âš ï¸ Cannot get logs"
                exit 1
              }
              echo "âœ… pdf-service started"
            fi

            # Show logs and status
            echo "ğŸ“Š pdf-service status:"
            pm2 status pdf-service || true
            echo "ğŸ“‹ Last 20 lines of pdf-service logs:"
            pm2 logs pdf-service --lines 20 --nostream || true

            # Deploy keysui
            cd ~/axon-digital/keysui
            pnpm install
            echo "ğŸ“¦ Building KeysUI..."
            pnpm run build || {
              echo "âŒ KeysUI build failed"
              echo "ğŸ“‹ Build error details:"
              pnpm run build 2>&1 | tail -50
              exit 1
            }
            echo "ğŸ“¦ KeysUI build completed"

            # Check if process exists
            echo "ğŸ” Checking pm2 status for keysui..."
            pm2 describe keysui 2>/dev/null || echo "âš ï¸ keysui not found in pm2"

            # Try to reload, if fails start new
            if pm2 reload keysui 2>/dev/null; then
              echo "âœ… keysui reloaded successfully"
            else
              echo "âš ï¸ keysui reload failed, starting new process..."
              cd ~/axon-digital/keysui
              # Use pm2 serve for static files (as per README)
              pm2 serve dist 5175 --name keysui --spa || {
                echo "âŒ Failed to start keysui"
                pm2 logs keysui --lines 50 --nostream || echo "âš ï¸ Cannot get logs"
                exit 1
              }
              echo "âœ… keysui started"
            fi

            # Show logs and status
            echo "ğŸ“Š keysui status:"
            pm2 status keysui || true
            echo "ğŸ“‹ Last 20 lines of keysui logs:"
            pm2 logs keysui --lines 20 --nostream || true

            # Final status
            echo "ğŸ“Š Final pm2 status:"
            pm2 list
            pm2 save || echo "âš ï¸ pm2 save failed"

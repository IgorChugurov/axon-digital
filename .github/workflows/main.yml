name: Main

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 31.220.80.11
          username: root
          port: 22
          key: ${{ secrets.SSHKEY }}
          script: |
            set -e
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²
            LOG_DIR="$HOME/deploy-logs"
            mkdir -p "$LOG_DIR"
            LOG_FILE="$LOG_DIR/deploy-$(date +%Y%m%d-%H%M%S).log"

            # Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ, Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»)
            log() {
              echo "$(date '+%Y-%m-%d %H:%M:%S') - $*" | tee -a "$LOG_FILE"
            }

            log "ğŸš€ Starting deployment..."
            export PATH="$HOME/.local/share/pnpm:$PATH"
            cd ~/axon-digital || exit 1
            git fetch origin main
            git reset --hard origin/main
            log "âœ… Git updated"

            # Deploy backend
            cd backend
            pnpm install
            pnpm run build
            log "ğŸ“¦ Backend build completed"

            # Check if Playwright browsers are installed (only install if missing)
            # This is a one-time setup, but we check to avoid reinstalling on every deploy
            if ! find "$HOME/.cache/ms-playwright" -name "chrome" -o -name "chromium" 2>/dev/null | grep -q .; then
              log "ğŸ“¦ Playwright browsers not found, installing (one-time setup)..."
              npx playwright install --with-deps chromium || log "âš ï¸ Playwright install failed, continuing..."
            else
              log "âœ… Playwright browsers already installed"
            fi

            # Check if process exists and get status
            log "ğŸ” Checking pm2 status for pdf-service..."
            pm2 list | tee -a "$LOG_FILE" || log "âš ï¸ pm2 list failed"
            pm2 describe pdf-service 2>/dev/null | tee -a "$LOG_FILE" || log "âš ï¸ pdf-service not found in pm2"

            # Check if process is in error state or has too many restarts
            PDF_STATUS=$(pm2 describe pdf-service 2>/dev/null | grep "status" | head -1 | awk '{print $4}' || echo "")
            if [ "$PDF_STATUS" = "errored" ]; then
              log "âš ï¸ pdf-service is in errored state, deleting and restarting..."
              pm2 delete pdf-service 2>/dev/null || true
              sleep 2
            fi

            # Try to reload, if fails start new
            if pm2 reload pdf-service 2>/dev/null; then
              log "âœ… pdf-service reloaded successfully"
            else
              log "âš ï¸ pdf-service reload failed, starting new process..."
              cd ~/axon-digital/backend
              pm2 start "pnpm run start" --name pdf-service --interpreter bash --cwd ~/axon-digital/backend || {
                log "âŒ Failed to start pdf-service"
                pm2 logs pdf-service --lines 50 --nostream | tee -a "$LOG_FILE" || log "âš ï¸ Cannot get logs"
                exit 1
              }
              log "âœ… pdf-service started"
            fi

            # Show logs and status
            log "ğŸ“Š pdf-service status:"
            pm2 status pdf-service | tee -a "$LOG_FILE" || true
            log "ğŸ“‹ Last 20 lines of pdf-service logs:"
            pm2 logs pdf-service --lines 20 --nostream | tee -a "$LOG_FILE" || true

            # Deploy keysui
            cd ~/axon-digital/keysui
            pnpm install
            log "ğŸ“¦ Building KeysUI..."
            pnpm run build 2>&1 | tee -a "$LOG_FILE" || {
              log "âŒ KeysUI build failed"
              log "ğŸ“‹ Build error details:"
              pnpm run build 2>&1 | tail -50 | tee -a "$LOG_FILE"
              exit 1
            }
            log "ğŸ“¦ KeysUI build completed"

            # Check if process exists and is in error state
            log "ğŸ” Checking pm2 status for keysui..."
            KEYSUI_STATUS=$(pm2 describe keysui 2>/dev/null | grep "status" | head -1 | awk '{print $4}' || echo "")

            # If process is errored, delete it first
            if [ "$KEYSUI_STATUS" = "errored" ]; then
              log "âš ï¸ keysui is in errored state, deleting old process..."
              pm2 delete keysui 2>/dev/null || true
              sleep 1
            fi

            # Try to reload, if fails start new
            if [ "$KEYSUI_STATUS" != "errored" ] && pm2 reload keysui 2>/dev/null; then
              log "âœ… keysui reloaded successfully"
            else
              log "âš ï¸ keysui reload failed or errored, starting new process..."
              cd ~/axon-digital/keysui
              
              # Verify dist directory exists
              if [ ! -d "dist" ]; then
                log "âŒ dist directory not found in keysui!"
                exit 1
              fi
              
              # Use pm2 serve with full absolute path
              pm2 serve ~/axon-digital/keysui/dist 5175 --name keysui --spa || {
                log "âŒ Failed to start keysui"
                pm2 logs keysui --lines 50 --nostream | tee -a "$LOG_FILE" || log "âš ï¸ Cannot get logs"
                exit 1
              }
              log "âœ… keysui started"
            fi

            # Show logs and status
            log "ğŸ“Š keysui status:"
            pm2 status keysui | tee -a "$LOG_FILE" || true
            log "ğŸ“‹ Last 20 lines of keysui logs:"
            pm2 logs keysui --lines 20 --nostream | tee -a "$LOG_FILE" || true

            # Final status
            log "ğŸ“Š Final pm2 status:"
            pm2 list | tee -a "$LOG_FILE"
            pm2 save || log "âš ï¸ pm2 save failed"

            log "âœ… Deployment completed successfully"
            log "ğŸ“ Full log saved to: $LOG_FILE"

            # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ»Ğ¾Ğ³Ñƒ
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Deployment log saved to: $LOG_FILE"
            echo "ğŸ“‹ View last deployment: tail -f $LOG_FILE"
            echo "ğŸ“‹ View all logs: ls -lth $LOG_DIR/"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# AI Assistant API Route (`POST /api/chat`)

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Ä–µ–∞–ª–∏–∑—É–µ—Ç POST-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ API –Ω–∞ Next.js 15, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ OpenAI Assistant –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—é, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç thread –≤ OpenAI, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç tool calls, –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–æ–∫ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

---

## üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞**

   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è IP –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è rate limiting.

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤**

   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π rate limiter (`rate-limiter-flexible`), —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤.

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è**

   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ, –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ/–¥–ª–∏–Ω–Ω–æ–µ (–Ω–∞ –æ—Å–Ω–æ–≤–µ `MIN_CHAR_LENGTH` / `MAX_CHAR_LENGTH`).

4. **–ú–æ–¥–µ—Ä–∞—Ü–∏—è**

   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ OpenAI Moderation API.
   - –í —Å–ª—É—á–∞–µ —Ñ–ª–∞–≥–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ thread-–∞**

   - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `threadId`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–Ω.
   - –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π thread —á–µ—Ä–µ–∑ `openai.beta.threads.create()`.

6. **–û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ run**

   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π `run` –≤ —Å—Ç–∞—Ç—É—Å–µ `in_progress` –∏–ª–∏ `queued`, –æ–Ω –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º.

7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MongoDB —Å –ø–æ–ª—è–º–∏ `threadId`, `role: "user"`, `content`, `ip`, `timestamp`.

8. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ OpenAI thread**

   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `openai.beta.threads.messages.create()`.

9. **–ó–∞–ø—É—Å–∫ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–∞**

   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `openai.beta.threads.runs.stream()` ‚Äî –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∏–º–∏—Ç—Å—è —á–∞—Å—Ç—è–º–∏.
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:
     - `thread.message.delta` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç;
     - `thread.run.step.delta` ‚Äî tool calls;
     - `thread.run.requires_action` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ tool call —á–µ—Ä–µ–∑ `handleToolCalls`.

10. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞**
    - –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MongoDB —Å `role: "assistant"`.

---

## üß± –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **OpenAI SDK** ‚Äî `openai`
- **MongoDB** ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- **RateLimiter** ‚Äî `rate-limiter-flexible`
- **Stream API** ‚Äî `ReadableStream` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
- **–ú–æ–¥—É–ª–∏**:
  - `checkRateLimit`
  - `moderateMessage`
  - `validateMessageInput`
  - `handleToolCalls`
  - `logMessageToDatabase`

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/utils/validateMessageInput.ts`
- `src/utils/moderateMessage.ts`
- `src/utils/checkRateLimit.ts`
- `src/utils/toolCallHandler.ts`
- `src/lib/db/logMessageToDatabase.ts`
- `src/types/openai.ts`

---

## üß™ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ

–ó–∞–ø—Ä–æ—Å:

```ts
const res = await fetch("/api/chat", {
  method: "POST",
  body: JSON.stringify({
    threadId,
    message: "–ü—Ä–∏–≤–µ—Ç, –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –º–Ω–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –±—Ä–∏—Ñ?",
    context: { goal: "digital agency brief" },
  }),
});
```
